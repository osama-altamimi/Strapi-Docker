name: ✍️ - Build and Publish the Image

on:
  push:
    paths:
      - 'scripts/**'
  workflow_dispatch:

jobs:
  build-image:
    name: 📌 - Build Image
    runs-on: ubuntu-latest

    steps:
      - name: Verify Login
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate Random keys
        id: generate_random_keys
        run: |
          APP_KEYS=$(openssl rand -base64 24),$(openssl rand -base64 24),$(openssl rand -base64 24),$(openssl rand -base64 24)
          ADMIN_JWT_SECRET=$(openssl rand -base64 24)
          API_TOKEN_SALT=$(openssl rand -base64 24)
          TRANSFER_TOKEN_SALT=$(openssl rand -base64 24)
          JWT_SECRET=$(openssl rand -base64 32)
          echo "::add-mask::$APP_KEYS"
          echo "::add-mask::$ADMIN_JWT_SECRET"
          echo "::add-mask::$API_TOKEN_SALT"
          echo "::add-mask::$TRANSFER_TOKEN_SALT"
          echo "::add-mask::$JWT_SECRET"
          echo "APP_KEYS=${APP_KEYS}" >> $GITHUB_ENV
          echo "ADMIN_JWT_SECRET=${ADMIN_JWT_SECRET}" >> $GITHUB_ENV
          echo "API_TOKEN_SALT=${API_TOKEN_SALT}" >> $GITHUB_ENV
          echo "TRANSFER_TOKEN_SALT=${TRANSFER_TOKEN_SALT}" >> $GITHUB_ENV
          echo "JWT_SECRET=${JWT_SECRET}" >> $GITHUB_ENV

      - name: Fetch Release Version
        id: fetch_release_version
        run: |
          version=$(jq -r ".version" scripts/package.json)
          echo "VERSION=${version}" >> $GITHUB_ENV

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: all

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Packages
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker image
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: |
            ghcr.io/${{ github.repository_owner }}/strapi:${{ env.VERSION }}
            ghcr.io/${{ github.repository_owner }}/strapi:latest
            ${{ secrets.DOCKER_USERNAME }}/strapi:${{ env.VERSION }}
            ${{ secrets.DOCKER_USERNAME }}/strapi:latest
          build-args: |
            APP_KEYS="${{ env.APP_KEYS }}"
            ADMIN_JWT_SECRET="${{ env.ADMIN_JWT_SECRET }}"
            API_TOKEN_SALT="${{ env.API_TOKEN_SALT }}"
            TRANSFER_TOKEN_SALT="${{ env.TRANSFER_TOKEN_SALT }}"
            JWT_SECRET="${{ env.JWT_SECRET }}"
